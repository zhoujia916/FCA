
<title>Puzzle Admin-广告管理</title>
<style type="text/css">

</style>
<div class="page-header">
    <h4>
        <i class="glyphicon glyphicon-signal"></i>
        广告管理
        <small>
            <i class="ace-icon fa fa-angle-double-right"></i>
            {{if $action eq 'CREATE'}}
                新增广告
            {{elseif $action eq 'UPDATE'}}
                编辑广告
            {{/if}}

        </small>

        <a class="btn btn-xs orange pull-right btn-warning" href="#page/fcaad/index">
            <i class="glyphicon glyphicon-arrow-left"></i>返回广告管理</span></a>
    </h4>
</div>

<div class="row" id="">
    <div class="col-xs-12">
        <form class="form-horizontal" id="form">
            <div class="tabbable">
                <ul class="nav nav-tabs padding-16">
                    <li class="active">
                        <a data-toggle="tab" href="#edit-basic">
                            <i class="green ace-icon fa fa-pencil-square-o bigger-125"></i>
                            基本信息
                        </a>
                    </li>
                </ul>

                <div class="tab-content profile-edit-tab-content">
                    <div id="edit-basic" class="tab-pane in active">
                        <div class="space-10"></div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">
                                广告链接
                            </label>
                            <div class="col-sm-9">
                                {{if $action eq 'CREATE'}}
                                <input type="text" id="adLink" name="adLink" placeholder="广告链接" class="txt input-sm col-sm-6">
                                {{elseif $action eq 'UPDATE'}}
                                <input hidden="hidden" name="adId" id="adId" value="{{$ad.adId}}"/>
                                <input type="text" id="adLink" name="adLink" placeholder="广告链接" value="{{$ad.adLink}}" class="txt input-sm col-sm-6">
                                {{/if}}
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">
                                广告图片
                            </label>
                            <div class="col-sm-4" style="height:62px;">
                                {{if $action eq 'CREATE' or $action eq 'UPDATE'}}
                                <input type="hidden" id="hidAdPic" name="pic" />
                                <input type="file" id="pic" name="file" placeholder="广告图片">
                                {{/if}}
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">
                                位置
                            </label>
                            <div class="col-sm-9">
                                {{if $action eq 'CREATE'}}
                                <select  id="adPositionId" name="adPositionId" class="select" data-init="0" >
                                    {{foreach from=$list item=aap}}
                                    <option value="{{$aap.positionId}}" {{if $aap.positionId == 1}}selected="selected"{{/if}}>{{$aap.positionName}}</option>
                                    {{/foreach}}
                                </select>
                                {{elseif $action eq 'UPDATE'}}
                                <select  id="adPositionId" name="adPositionId" class="select" data-init="0" >
                                    {{foreach from=$list item=aap}}
                                    <option value="{{$aap.positionId}}" {{if $aap.positionId == $positionId}}selected="selected"{{/if}}>{{$aap.positionName}}</option>
                                    {{/foreach}}
                                </select>
                                {{/if}}
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">
                                开始时间
                            </label>
                            <div class="col-sm-9">
                                {{if $action eq 'CREATE'}}
                                <input type="text" id="startDate" name="beginTimeString" placeholder="开始时间" class="txt input-sm col-sm-5 "/>
                                {{elseif $action eq 'UPDATE'}}
                                <input type="text" id="startDate" name="beginTimeString" value="{{$ad.beginTimeString}}" placeholder="开始时间" class="txt input-sm col-sm-5 "/>
                                {{/if}}
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">
                                结束时间
                            </label>
                            <div class="col-sm-9">
                                {{if $action eq 'CREATE'}}
                                <input type="text" id="endDate" name="endTimeString" placeholder="结束时间" class="txt input-sm col-sm-5 "/>
                                {{elseif $action eq 'UPDATE'}}
                                <input type="text" id="endDate" name="endTimeString" value="{{$ad.endTimeString}}" placeholder="结束时间" class="txt input-sm col-sm-5 "/>
                                {{/if}}
                            </div>
                        </div>
                    </div>

                    <div id="edit-pics" class="tab-pane">
                        <div class="space-10"></div>
                        {{if $action eq 'CREATE'}}
                        <input type="hidden" id="hidPic" name="pic" value="" />
                        {{elseif $action eq 'UPDATE'}}
                        <input type="hidden" id="hidPic" name="pic" value="{{foreach from=$picList item=picItem key=index}}{{if $index gt 0}}※{{/if}}{{$picItem.path}}{{/foreach}}" />
                        {{/if}}
                        <div class="dropzone" id="dropzone">
                            <div class="fallback">
                                <input type="file" multiple="" />
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            {{if $action eq 'CREATE' or $action eq 'UPDATE'}}
            <div class="clearfix form-actions">
                <button id="btnReset" class="btn" type="reset">
                    <i class="ace-icon fa fa-undo bigger-110"></i>
                    重置
                </button>
                &nbsp; &nbsp;
                <button id="btnSubmit" data-action="{{$action}}" class="btn btn-info" type="button">
                    <i class="ace-icon fa fa-check bigger-110"></i>
                    确定
                </button>
            </div>
            {{/if}}
        </form>


    </div><!-- /.col -->
</div><!-- /.row -->
<script type="text/javascript">
    $('.page-content-area').ace_ajax('loadScripts', [null, null], function() {
        {{if $action eq 'CREATE' or $action eq 'UPDATE'}}
        var spliter = "※";
        $("#btnSubmit").on("click",function(){

        });

        $("#startDate").datepicker({
            showOtherMonths: true,
            selectOtherMonths: false
        });

        $("#endDate").datepicker({
            showOtherMonths: true,
            selectOtherMonths: false
        });

        var userAvatar = $('#pic').ace_file_input({
            style:'well',
            allowExt: ["jpeg", "jpg", "png", "gif" , "bmp"],
            allowMime: ["image/jpg", "image/jpeg", "image/png", "image/gif", "image/bmp"],

            btn_choose:'拖放或点击选择图片',
            btn_change:null,
            no_icon:'ace-icon fa fa-cloud-upload',
            droppable:true,
            thumbnail:'small',
            //,icon_remove:null//set null, to hide remove/reset button
            /**,before_change:function(files, dropped) {
						//Check an example below
						//or examples/file-upload.html
						return true;
					}*/
            before_remove : function() {
                $("#hidAdPic").val("");
                return true;
            },
            preview_error : function(filename, error_code) {
                var errorMsg = '';
                if(error_code == 2){
                    errorMsg = "加载读取图片出错";
                }else if(error_code == 3){
                    errorMsg = "创建缩列图出错";
                }
                showTip(errorMsg);
                //name of the file that failed
                //error_code values
                //1 = 'FILE_LOAD_FAILED',
                //2 = 'IMAGE_LOAD_FAILED',
                //3 = 'THUMBNAIL_FAILED'
                //alert(error_code);
            }
        });
        {{/if}}
        {{if $action eq 'UPDATE'}}
        var files = [{
            name: "temp.jpeg",
            type: "image",
            path: "{{$ad.pic}}"
        }];
        userAvatar.ace_file_input("show_file_list", files, false);
        {{/if}}


        Dropzone.autoDiscover = false;
        var dropZone = new Dropzone("#dropzone" , {
            paramName: "upfile",
            params: {type:"userauth"},
            maxFilesize: 1, // MB
            maxFiles: 5,
            method:"post",
            url: "{{$contextPath}}/plugin/uploader",
            success:function(file){
                console.log("success");
                var result = $.parseJSON(file.xhr.response);
                if(result.code == 0){
                    file.path = result.data;
                    var pic = $("#hidPic").val();
                    pic += pic != "" ? (spliter + result.data) : result.data;
                    $("#hidPic").val(pic);

                    $(".dz-details img[data-dz-thumbnail]", file.previewTemplate).attr("src", file.path);

                }
                else{
                    showAlert("上传失败....");
                }

                if (file.previewElement) {
                    return file.previewElement.classList.add("dz-success");
                }
            },
            removedfile: function(file){
                console.log("removedfile");
                var pics = $("#hidPic").val().split(spliter);
                for(var i = 0; i < pics.length; i++){
                    if(pics[i] == file.path){
                        pics = pics.splice(i, 1);
                        break;
                    }
                }
                $("#hicPic").val(pics.join(spliter));


                var _ref;
                if (file.previewElement) {
                    if ((_ref = file.previewElement) != null) {
                        _ref.parentNode.removeChild(file.previewElement);
                    }
                }
                return this._updateMaxFilesReachedClass();
            },
            dictCancelUpload: "取消上传",
            dictCancelUploadConfirmation: "您确定取消上传?",
            dictRemoveFile: "移除文件",
            dictRemoveFileConfirmation: null,
            dictMaxFilesExceeded: "您不能上传更多文件了.",
            dictDefaultMessage: "拖放文件上传",
            dictFallbackMessage: "您的浏览器不知拖放",
            addRemoveLinks : true,
            dictDefaultMessage :
                    '<span class="bigger-120 bolder"><i class="ace-icon fa fa-caret-right red"></i>拖放</span>文件上传 \
                    <span class="smaller-80 grey">(或单击)</span> <br /> \
                    <i class="upload-icon ace-icon fa fa-cloud-upload blue fa-2x"></i>'
            ,
            dictResponseError: '上传文件出错!',
            //change the previewTemplate to use Bootstrap progress bars
            previewTemplate: "<div class=\"dz-preview dz-file-preview\">\n  <div class=\"dz-details\">\n    <div class=\"dz-filename\"><span data-dz-name></span></div>\n    <div class=\"dz-size\" data-dz-size></div>\n    <img data-dz-thumbnail />\n  </div>\n  <div class=\"progress progress-small progress-striped active\"><div class=\"progress-bar progress-bar-success\" data-dz-uploadprogress></div></div>\n  <div class=\"dz-success-mark\"><span></span></div>\n  <div class=\"dz-error-mark\"><span></span></div>\n  <div class=\"dz-error-message\"><span data-dz-errormessage></span></div>\n</div>"
        });
        {{if $action eq 'UPDATE'}}
        var mockFileList = [];
        {{foreach from=$picList item=picItem}}
        mockFileList.push({ name: "temp.jpg", size: "10000", path: "{{$picItem.path}}" });
        {{/foreach}}
        for(var i = 0; i < mockFileList.length; i++){
            dropZone.emit("addedfile", mockFileList[i]);

            dropZone.emit("thumbnail", mockFileList[i], mockFileList[i].path);

            dropZone.emit("complete", mockFileList[i]);
        }
        {{/if}}
    });
</script>
